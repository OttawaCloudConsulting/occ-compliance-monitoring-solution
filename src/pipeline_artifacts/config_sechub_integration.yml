AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Automated importing of aws config findings into aws security hub
Parameters:
  S3Bucket:
    Type: String
  S3Key:
    Type: String
  LambdaHandler:
    Type: String
  pDefaultRegion:
    Type: String
    Default: ca-central-1
  IAMRoleName:
    Type: String
    Default: config-sechub-lambda-role
  IAMRoleNameStandardsManager:
    Type: String
    Default: securityhub-standards-manager
  pDefaultAccountId:
    Type: String 
    Description: Deployment AccountId (usually MRA)
  pS3ObjectVersion:
    Type: String
    Description: S3 Object Version Id generated by TF Upload Step
  # pTopicArn:
  #   Type: String
  #   Description: ARN for the associated SNS Topic # We comment this out so that we can use parameter stored variable
Conditions: 
## Added to handle multi-region deployment
  IsDefaultRegion: !Equals 
    - !Ref pDefaultRegion
    - !Ref "AWS::Region"
  IsNotDefaultRegion: 
    !Not [!Equals [!Ref pDefaultRegion, !Ref "AWS::Region"]]
Resources:
  ConfigSecHubFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket: !Ref S3Bucket
        S3Key: !Ref S3Key
        S3ObjectVersion: !Ref pS3ObjectVersion
      FunctionName: Config-SecHub-Lambda
      Handler:  !Ref LambdaHandler
      Role: 
        !Sub arn:aws:iam::${AWS::AccountId}:role/${IAMRoleName}
      Runtime: python3.7
      Timeout: 300
      Environment:
        Variables:
          TOPICARN: '{{resolve:ssm:/org/member/local_sns_arn:1}}' #Use parameter stored LZ topic in each account #!Ref pTopicArn
  ConfigSecHubCWRule:
    Type: 'AWS::Events::Rule'
    Properties:
      Description: >-
        This CW rule integrates AWS Config Compliance events with AWS Lambda as a target
      Name: Config-Sechub-CW-Rule
      EventPattern:
        source:
          - aws.config
        detail-type:
          - Config Rules Compliance Change
        detail:
          messageType:
            - ComplianceChangeNotification
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - ConfigSecHubFunction
              - Arn
          Id: TargetFunctionV1
  PermissionForEventsToInvokeLambda:
    Type: 'AWS::Lambda::Permission'
    Properties:
      FunctionName:
        Ref: ConfigSecHubFunction
      Action: 'lambda:InvokeFunction'
      Principal: events.amazonaws.com
      SourceArn:
        'Fn::GetAtt':
          - ConfigSecHubCWRule
          - Arn